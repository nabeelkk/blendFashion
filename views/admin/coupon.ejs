<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Coupons | The Style</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="dashboard" class="brand-wrap">
                <img src="/adminassets/imgs/theme/logo.png" class="logo" alt="Evara Dashboard">
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i>
                </button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item">
                    <a class="menu-link" href="dashboard"> <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item has-submenu">
                    <a class="menu-link" href=""> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Products</span>
                    </a>
                    <div class="submenu">
                        <a href="productList">Product List</a>
                        <a href="categories">Categories</a>
                        <a href="categoryoffer">Category Offer</a>
                    </div>

                </li>
                <li class="menu-item has-submenu ">
                    <a class="menu-link" href=""> <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Orders</span>
                    </a>
                    <div class="submenu">
                        <a href="orderlist">Order list </a>
                    </div>
                </li>
                
                <li class="menu-item ">
                    <a class="menu-link" href="addProducts"> <i class="icon material-icons md-add_box"></i>
                        <span class="text">Add product</span>
                    </a>

                </li>
               
                <li class="menu-item ">
                    <a class="menu-link" href="users"> <i class="icon material-icons md-person"></i>
                        <span class="text">Users</span> 
                    </a>

                </li>
                <li class="menu-item active">
                    <a class="menu-link" href="couponList"> <i class="icon material-icons md-local_offer"></i>
                        <span class="text">Coupon</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="salesReport"> <i class="icon material-icons md-monetization_on"></i>
                        <span class="text">Sales Report</span>
                    </a>
                </li>
                 <li class="menu-item">
                    <a class="menu-link" href="page-reviews.html"> <i class="icon material-icons md-comment"></i>
                        <span class="text">Reviews</span>
                    </a>
                </li> 
                <li class="menu-item">
                    <a class="menu-link" href="brand"> <i class="icon material-icons md-stars"></i>
                        <span class="text">Brands</span> </a>
                </li>
                
            </ul>
            <br>
            <br>
        </nav>
    </aside>
  <div class="container mt-5">
    <h2>Manage Coupons</h2>
    <header class="main-header navbar">
            <div class="col-search">
                <form class="searchform">
                    <div class="input-group">
                        <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                        <button class="btn btn-light bg" type="button"> <i class="material-icons md-search"></i></button>
                    </div>
                </form>
            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                <ul class="nav">
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="/adminassets/imgs/people/avtar.png" alt="User"></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                            <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit Profile</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account Settings</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help center</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="/admin/logout"><i class="material-icons md-exit_to_app"></i>Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </header>
    <!-- Create Coupon Form -->
    <form id="createCouponForm" class="mb-4">
      <div class="mb-3">
        <label for="code" class="form-label">Coupon Code</label>
        <input type="text" class="form-control" id="code" name="code" required>
      </div>
      <div class="mb-3">
        <label for="discount" class="form-label">Discount</label>
        <input type="number" class="form-control" id="discount" name="discount" required>
      </div>
      <div class="mb-3">
        <label for="discountType" class="form-label">Discount Type</label>
        <select class="form-control" id="discountType" name="discountType" required>
          <option value="percentage">Percentage</option>
          <option value="fixed">Fixed</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="maxDiscount" class="form-label">Max Discount (Optional)</label>
        <input type="number" class="form-control" id="maxDiscount" name="maxDiscount">
      </div>
      <div class="mb-3">
        <label for="minPurchase" class="form-label">Minimum Purchase</label>
        <input type="number" class="form-control" id="minPurchase" name="minPurchase" value="0">
      </div>
      <div class="mb-3">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" class="form-control" id="startDate" name="startDate" required>
      </div>
      <div class="mb-3">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" class="form-control" id="endDate" name="endDate" required>
      </div>
      <div class="mb-3">
        <label for="usageLimit" class="form-label">Usage Limit (Optional)</label>
        <input type="number" class="form-control" id="usageLimit" name="usageLimit">
      </div>
      <div class="mb-3">
        <label for="applicableTo" class="form-label">Applicable To</label>
        <select class="form-control" id="applicableTo" name="applicableTo">
          <option value="all">All Products</option>
          <option value="specific_products">Specific Products</option>
          <option value="specific_categories">Specific Categories</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Create Coupon</button>
    </form>

    <!-- Coupons List -->
    <table class="table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Discount</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="couponsTable"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('createCouponForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch('/admin/coupons', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        const result = await response.json();
        if (result.error) {
          Swal.fire('Error', result.error, 'error');
        } else {
          Swal.fire('Success', 'Coupon created successfully', 'success');
          loadCoupons();
        }
      } catch (error) {
        Swal.fire('Error', 'Failed to create coupon', 'error');
      }
    });

    async function loadCoupons() {
      const response = await fetch('/admin/coupons');
      const coupons = await response.json();
      const tbody = document.getElementById('couponsTable');
      tbody.innerHTML = '';

      coupons.forEach(coupon => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${coupon.code}</td>
          <td>${coupon.discount}${coupon.discountType === 'percentage' ? '%' : 'â‚¹'}</td>
          <td>${coupon.discountType}</td>
          <td>${new Date(coupon.startDate).toLocaleDateString()}</td>
          <td>${new Date(coupon.endDate).toLocaleDateString()}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteCoupon('${coupon._id}')">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    async function deleteCoupon(id) {
      if (confirm('Are you sure you want to delete this coupon?')) {
        try {
          const response = await fetch(`/admin/coupons/${id}`, { method: 'DELETE' });
          const result = await response.json();
          if (result.error) {
            Swal.fire('Error', result.error, 'error');
          } else {
            Swal.fire('Success', 'Coupon deleted successfully', 'success');
            loadCoupons();
          }
        } catch (error) {
          Swal.fire('Error', 'Failed to delete coupon', 'error');
        }
      }
    }

    loadCoupons();
  </script>
</body>
</html>