<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | The Style</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style1.css">
</head>
<body>
   
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top py-3">
            <div class="container">
                <a href=""><img style="width: 100px; height: 40px;" src="/adminassets/imgs/theme/logo.png" alt=""></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="/">Home</a>
                        </li>
                        <li class="nav-item">
                            <% if (!user) { %>
                                <a class="nav-link" href="/login">Shop</a>
                                <% } else { %>
                                    <a class="nav-link" href="/products">Shop</a>
                            <% } %>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/brand">Brands</a>
                        </li>
                        <li class="nav-item">
                            <% if (!user) { %>
                                <a class="nav-link" href="/login">New Arrivals</a>
                                <% } else { %>
                                    <a class="nav-link" href="/newarrival">New Arrivals</a>
                            <% } %>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Contact</a>
                        </li>
                    </ul>
                    <div class="d-flex">
                        <% if (user) { %>
                            <a href="/userDash" class="nav-icon me-3"><i class="fas fa-user"></i></a>
                           <% } %>
                        <% if (!user) { %>
                            <a href="/login" class="nav-icon me-3 position-relative">
                                <i class="fas fa-shopping-bag"></i>
                                <span class="cart-count">2</span>
                            </a>
                            <% } else { %>
                                <a href="/cart" class="nav-icon me-3 position-relative">
                                    <i class="fas fa-shopping-bag"></i>
                                     <% if (cartCount) { %>
                                  <span class="cart-count"><%= cartCount%></span>
                                  <% } else { %>
                                    <span class="cart-count">0</span>
                                <% } %>
                                </a>
                        <% } %>
                        <% if (!user) { %>
                            <a href="/login" style="padding: 5px;font-size: 12px;font-weight: bold;" class="btn btn-dark btn-lg me-2 mb-2">Login</a>
                            <a href="/signup" style="padding: 5px;font-size: 12px;font-weight: bold;" class="btn btn-dark btn-lg me-2 mb-2">Signup</a>
                        <% } %>
                        <% if (user) { %>
                            <a href="/logout" style="padding: 5px;font-size: 12px;font-weight: bold;margin-left: 25px;" class="btn btn-dark btn-lg me-2 mb-2">Logout</a>
                           <% } %>
    
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Account Dashboard -->
    <section class="account-dashboard py-5">
        <div class="container">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3 mb-4 mb-lg-0">
                    <div class="account-sidebar">
                        <div class="user-profile text-center mb-4">
                            <div class="user-avatar mb-3">
                                <img src="/adminassets/imgs/people/ddd.png" alt="User Avatar" class="rounded-circle" width="80" height="80">
                            </div>
                            
                            <h5 class="user-name mb-1"><%= user.name %></h5>
                            <p class="user-email text-muted mb-0"><%= user.email %></p>
                        </div>
                        <div class="list-group">
                            <a href="userDash" class="list-group-item list-group-item-action active">
                                <i class="fas fa-tachometer-alt me-2"></i> My Profile
                            </a>
                            <a href="myOrder" class="list-group-item list-group-item-action">
                                <i class="fas fa-shopping-bag me-2"></i> My Orders
                            </a>
                            <a href="wishlist" class="list-group-item list-group-item-action">
                                <i class="fas fa-heart me-2"></i> My Wishlist
                            </a>
                            <a href="address" class="list-group-item list-group-item-action">
                                <i class="fas fa-map-marker-alt me-2"></i> My Addresses
                            </a>
                            <a href="mywallet" class="list-group-item list-group-item-action">
                                <i class="fas fa-wallet me-2"></i> My Wallet
                            </a>
                            <a href="logout" class="list-group-item list-group-item-action text-danger">
                                <i class="fas fa-sign-out-alt me-2"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Content -->
                <div class="col-lg-9">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                                </div>
                                <div class="modal-body">
                                    <form action="/editprofile" method="post" enctype="multipart/form-data">
                                        <!-- Profile Image Upload Section -->  
                                            <div class="mb-4 text-center">
                                                <div class="profile-avatar-wrapper mx-auto" style="width: 120px; height: 120px; position: relative;">
                                                    <img src="adminassets/imgs/people/ddd.png" alt="Profile Picture" id="profileImagePreview" class="img-fluid rounded-circle border" style="width: 100%; height: 100%; object-fit: cover;">
                                                    <label for="profileImageUpload" class="position-absolute bottom-0 end-0 bg-dark text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; cursor: pointer;">
                                                        <i class="fas fa-camera"></i>
                                                        <input type="file" name="profileImage" id="profileImageUpload" accept="image/*" onchange="previewProfileImage(this)" style="display: none;">
                                                    </label>
                                                </div>
                                                <p class="text-muted small mt-2">Click the camera icon to upload a new profile picture</p>
                                            </div>
                                        <p style="color: red; font-size: 15px;"><%= error %></p>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="editFullName" class="form-label">Full Name</label>
                                                    <input type="text" class="form-control" name="name" id="editFullName" value="<%= user.name %>" required>
                                                </div>
                        
                                                <div class="col-md-6">
                                                    <label for="editEmail" class="form-label">Email</label>
                                                    <input type="email" class="form-control" name="email" id="editemail" value="<%= user.email %>" required>
                                                </div>
                                            </div>
                        
                                
                        
                                            <div class="mb-3 col-md-6">
                                                <label for="editPhone" class="form-label">Phone Number</label>
                                                <input type="tel" class="form-control" id="editPhone" name="phone" value="<%= user.phone %>" required>
                                                <span id="errorphone" style="color: red;"></span>
                                            </div>
                                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                                Change Password
                                              </button>
                                            
                                    
                                        <div class="modal-footer gap-3">
                                            <!-- <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button> -->
                                            <button type="submit" onclick="updateProfile(event)" class="btn btn-dark">Update Profile</button>
                                        </div>
                                    </form>
                                    
                                </div>
                           
                        </div>
                    
                </div>
            </div>
        </div>
    </section>
    <!-- Password Change Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
      
        <div class="modal-header">
          <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <form id="changePasswordForm">
          <div class="modal-body">
            
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Current Password</label>
              <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
              <span id="error-currentPassword" style="color: red;"></span>
            </div>
            
            <div class="mb-3">
              <label for="newPassword" class="form-label">New Password</label>
              <input type="password" class="form-control" id="newPassword" name="newPassword" required>
              <span id="error-newPassword" style="color: red;"></span>
            </div>
            
            <div class="mb-3">
              <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword" required>
              <span id="error-confirmNewPassword" style="color: red;"></span>
            </div>
          
          </div>
          
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Change Password</button>
          </div>
        </form>
  
      </div>
    </div>
  </div>
  

    <!-- Footer -->
    <%- include('../partials/footer') %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="js/script.js"></script>
                        
    <script>
        // Function to preview the profile image before upload
        function previewProfileImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('profileImagePreview').src = e.target.result;
                }
                
                reader.readAsDataURL(input.files[0]);
                uploadProfileImage(input.files[0]);
            }
        }

        function uploadProfileImage(file) {
            const formData = new FormData();
            formData.append('profileImage', file);
            console.log("here")
            fetch('/upload-profile-image', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Profile image updated successfully');
                
                    const profileImages = document.querySelectorAll('.user-profile-image');
                    profileImages.forEach(img => {
                        img.src = data.imageUrl;
                    });
                    
                    document.getElementById('profileImagePreview').src = data.imageUrl;
                } else {
                    showToast('Failed to update profile image: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error uploading profile image:', error);
                showToast('Error uploading profile image. Please try again.', 'error');
            });
        }
        
        // Function to update profile (to be implemented)
        function updateProfile(e) {
           
            const phoneInput = document.getElementById('editPhone').value;
            const errorElement = document.getElementById('errorphone');
            

            errorElement.textContent = '';
            if (!phoneInput) {
                errorElement.textContent = 'Phone number is required';
                e.preventDefault()
                return false;
            }

            phone = phoneInput.replace(/[\s\-\(\)]/g, '');
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(phone)) {
                errorElement.textContent = 'Please enter a valid 10-digit phone number (numbers only)';
                e.preventDefault()
                return false;
            }
            if (/^(\d)\1{9}$/.test(phone)) {
                errorElement.textContent = 'Phone number cannot consist of the same digit repeated';
                e.preventDefault()
                return false;
            }
            if (phone === '1234567890' || phone === '0987654321') {
                
                errorElement.textContent = 'Sequential phone numbers are not allowed';
                e.preventDefault()
                return false;
            }
            const validStartDigits = /^[6-9]/;
            if (!validStartDigits.test(phone)) {
                errorElement.textContent = 'Phone number must start with 6, 7, 8, or 9';
                e.preventDefault()
                return false;
            }
            return true;
            
        }
            
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

            const errorCurrentPassword = document.getElementById('error-currentPassword');
            const errorNewPassword = document.getElementById('error-newPassword');
            const errorConfirmNewPassword = document.getElementById('error-confirmNewPassword');

 
            errorCurrentPassword.style.display = 'none';
            errorCurrentPassword.textContent = '';
            errorNewPassword.style.display = 'none';
            errorNewPassword.textContent = '';
            errorConfirmNewPassword.style.display = 'none';
            errorConfirmNewPassword.textContent = '';

            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmNewPassword = confirmNewPasswordInput.value.trim();

            let isValid = true;
            if (!currentPassword) {
                errorCurrentPassword.style.display = 'block';
                errorCurrentPassword.textContent = 'Current password is required';
                isValid = false;
            }

            if (!newPassword) {
                errorNewPassword.style.display = 'block';
                errorNewPassword.textContent = 'New password is required';
                isValid = false;
            }

            if (!confirmNewPassword) {
                errorConfirmNewPassword.style.display = 'block';
                errorConfirmNewPassword.textContent = 'Confirm password is required';
                isValid = false;
            }

            if (currentPassword.length < 6) {
                errorCurrentPassword.style.display = 'block';
                errorCurrentPassword.textContent = 'Current password must be at least 6 characters';
                isValid = false;
            }

            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                errorNewPassword.style.display = 'block';
                errorNewPassword.textContent = 'New password must be at least 8 characters, including an uppercase letter, lowercase letter, number, and special character (@$!%*?&)';
                isValid = false;
            }

            const weakPatterns = [
                /^(.)\1+$/, 
                '12345678', 
                'password', 
                'qwertyui', 
            ];
            if (weakPatterns.some(pattern => (typeof pattern === 'string' ? newPassword.toLowerCase().includes(pattern) : pattern.test(newPassword)))) {
                errorNewPassword.style.display = 'block';
                errorNewPassword.textContent = 'New password is too weak or contains common patterns';
                isValid = false;
            }
            if (newPassword === currentPassword) {
                errorNewPassword.style.display = 'block';
                errorNewPassword.textContent = 'New password cannot be the same as the current password';
                isValid = false;
            }
            if (newPassword !== confirmNewPassword) {
                errorConfirmNewPassword.style.display = 'block';
                errorConfirmNewPassword.textContent = 'Confirm password does not match new password';
                isValid = false;
            }

            isValid =true

            try {
 
                const response = await fetch('/user/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                    
                });
                const result = await response.json();

                if (result.success) {
                    showToast(result.message|| '','success');
                    setTimeout(()=>{
                        const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                        modal.hide();
                        window.location.reload()
                    },2000)
                } else {
                    showToast(result.message || '','error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Server error','info');
            }
});

    </script>
</body>
</html>